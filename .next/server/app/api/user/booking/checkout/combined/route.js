(()=>{var e={};e.id=2004,e.ids=[2004],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},6269:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>I,routeModule:()=>f,serverHooks:()=>k,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>m});var n={};r.r(n),r.d(n,{POST:()=>p});var o=r(96559),i=r(48088),s=r(37719),a=r(96330),l=r(97474),u=r(32190),c=r(59145),d=r(15821),g=r(62802);async function p(e){let t=e.cookies.get("token")?.value;if(!t)return u.NextResponse.json({error:"Unauthorized"},{status:401});let r=(0,g.nr)(t,!0);if(!r)return u.NextResponse.json({error:"Invalid token"},{status:403});if("USER"!==r.role&&"HOTEL_OWNER"!==r.role)return u.NextResponse.json({error:"Access Denied"},{status:403});try{let t;let{bookingId:n,cardNumber:o,expiryDate:i}=await e.json();if(!n||!o||!i)return u.NextResponse.json({error:"Missing required fields"},{status:400});let s=await l.z.booking.findUnique({where:{id:n},include:{hotel:!0,room:!0}});if(!s)return u.NextResponse.json({error:"Booking not found"},{status:404});if(s.userId!==r.id)return u.NextResponse.json({error:"Access Denied"},{status:403});if(s.bookStatus!==a.BookingStatus.PENDING)return u.NextResponse.json({error:"This booking is not pending"},{status:400});let g=(0,c.validatePaymentDetails)(o,i);if(!g.isValid)return u.NextResponse.json({error:g.error},{status:400});if(await l.z.payment.findUnique({where:{bookingId:s.id}}))return u.NextResponse.json({error:"Payment already exists for this booking"},{status:400});let p=0,f=0;if(s.roomId){let e=await l.z.room.findUnique({where:{id:Number(s.roomId)}});if(s.checkIn&&s.checkOut){let t=new Date(s.checkIn);f=(new Date(s.checkOut).getTime()-t.getTime())/864e5,p+=e.pricePerNight*f}}if(s.flightBookingInfo){let e=JSON.parse(s.flightBookingInfo);p+=e.flights.reduce((e,t)=>e+t.price,0)}let h=await l.z.payment.create({data:{bookingId:s.id,cardNumber:o,expiryDate:i,amount:p,status:a.PaymentStatus.SUCCESS}});if(s.flightBookingInfo){let e=JSON.parse(s.flightBookingInfo);if(e.flights&&e.flights.length>0){let t=await l.z.user.findUnique({where:{id:r.id}}),n={firstName:t.firstName,lastName:t.lastName,email:t.email,passportNumber:"A12345678",flightIds:e.flights.map(e=>e.flightid)},o=process.env.AFS_URL,i=process.env.AFS_API_KEY,a=`${o}/api/bookings`;try{let e=await fetch(a,{method:"POST",headers:{"x-api-key":i,"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await e.json();if("CONFIRMED"!==t.status)return u.NextResponse.json({error:`AFS booking not confirmed: ${t.status}`},{status:400});await l.z.booking.update({where:{id:s.id},data:{reference:t.bookingReference}})}catch(e){return u.NextResponse.json({error:"AFS booking failed"},{status:500})}}}s.roomBookingInfo&&s.room&&await l.z.room.update({where:{id:s.room.id},data:{available:!1}});let m=await l.z.booking.update({where:{id:s.id},data:{bookStatus:a.BookingStatus.CONFIRMED}});try{t=await (0,d.generateInvoice)(m,h,r)}catch(e){return u.NextResponse.json({error:"Invoice generation failed"},{status:500})}let k=t.toString("base64");return await l.z.notification.create({data:{userId:r.id,message:`ðŸŽ‰ Your booking #${s.id} has been confirmed! 
                ${s.hotel?`
Hotel: ${s.hotel.name}`:""}
                ${s.flightBookingInfo?"\nFlight details have been confirmed":""}
                
Check your email for the invoice and booking details.`}}),s.hotel&&s.hotel.ownerId&&await l.z.notification.create({data:{userId:s.hotel.ownerId,message:`ðŸ“… New Booking Alert!
                    
Booking #${s.id} has been confirmed for your hotel.
                    ${s.checkIn?`
Check-in: ${new Date(s.checkIn).toLocaleDateString()}`:""}
                    ${s.checkOut?`
Check-out: ${new Date(s.checkOut).toLocaleDateString()}`:""}`}}),u.NextResponse.json({message:"Payment processed, booking confirmed, and invoice generated.",invoice:k,amount:h.amount},{status:200})}catch(e){return console.log(e.message),u.NextResponse.json({error:"Internal server error"},{status:500})}}let f=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/user/booking/checkout/combined/route",pathname:"/api/user/booking/checkout/combined",filename:"route",bundlePath:"app/api/user/booking/checkout/combined/route"},resolvedPagePath:"/app/app/api/user/booking/checkout/combined/route.js",nextConfigOutput:"",userland:n}),{workAsyncStorage:h,workUnitAsyncStorage:m,serverHooks:k}=f;function I(){return(0,s.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:m})}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},15821:(e,t,r)=>{"use strict";r.r(t),r.d(t,{POST:()=>u,generateInvoice:()=>l,runtime:()=>a});let n=require("pdfkit");var o=r.n(n),i=r(27910),s=r(97474);let a="nodejs";async function l(e,t,r){console.log("generateInvoice: started"),console.log("Booking:",e),console.log("Payment:",t),console.log("User:",r);let n=await s.z.user.findUnique({where:{id:r.id}}),a=null,l="";if(e.flightBookingInfo){try{a=JSON.parse(e.flightBookingInfo)}catch(e){console.error("Error parsing flightBookingInfo:",e)}a&&(Array.isArray(a.flights)?(l+="Flight Information (Round/Multiple Segments):\n",a.flights.forEach((e,t)=>{l+=`  Flight ${t+1}:
    Flight Number: ${e.flightNumber}
    Origin: ${e.origin}
    Destination: ${e.destination}
    Airline: ${e.airline}
    Departure: ${new Date(e.departureTime).toLocaleString()}
    Arrival: ${new Date(e.arrivalTime).toLocaleString()}
    Status: ${e.status}
    Price: $${e.price}

`})):l+=`Flight Information:
  Flight Number: ${a.flightNumber}
  Origin: ${a.origin}
  Destination: ${a.destination}
  Airline: ${a.airline}
  Departure: ${new Date(a.departureTime).toLocaleString()}
  Arrival: ${new Date(a.arrivalTime).toLocaleString()}
  Status: ${a.status}
  Price: $${a.price}
`)}let u=null,c=null,d=null,g=null,p=null;if(e.roomBookingInfo){try{u=JSON.parse(e.roomBookingInfo)}catch(e){console.error("Error parsing roomBookingInfo:",e)}u&&(g=u.hotelId||null,p=u.roomId||null,c=u.checkIn?new Date(u.checkIn):null,d=u.checkOut?new Date(u.checkOut):null)}c=c||(e.checkIn?new Date(e.checkIn):null),d=d||(e.checkOut?new Date(e.checkOut):null),g=g||e.hotelId||null,p=p||e.roomId||null;let f=new(o())({autoFirstPage:!1}),h=new i.PassThrough,m=[];return f.pipe(h),h.on("data",e=>m.push(e)),f.addPage(),f.font("Times-Roman"),f.fontSize(18).text("FlyNext Booking Invoice",{align:"center"}),f.moveDown(),f.fontSize(12).text(`Name: ${n.firstName} ${n.lastName}`),f.text(`Email: ${n.email}`),f.moveDown(),f.text(`Booking ID: ${e.id}`),f.moveDown(),e.flightBookingInfo&&(f.text("Flight Details:"),l?f.text(l):f.text(e.flightBookingInfo),f.moveDown()),g&&p&&(f.text(`Hotel Booking: Hotel ID ${g}, Room ID ${p}`),c&&d&&(f.text(`Check-In: ${c.toLocaleDateString()}`),f.text(`Check-Out: ${d.toLocaleDateString()}`)),f.moveDown()),f.text(`Total Amount: $${t.amount}`),f.text(`Payment Status: ${t.status}`),f.end(),new Promise((e,t)=>{h.on("end",()=>{console.log("generateInvoice: Invoice generated successfully"),e(Buffer.concat(m))}),h.on("error",e=>{console.error("generateInvoice: Error generating invoice:",e),t(Error("Failed to generate PDF invoice."))})})}async function u(e){try{let{booking:t,payment:r,user:n}=await e.json();if(!t||!r||!n)return new Response(JSON.stringify({message:"Missing required fields: booking, payment, and user"}),{status:400});let o=await l(t,r,n);return new Response(o,{status:200,headers:{"Content-Type":"application/pdf","Content-Disposition":'attachment; filename="invoice.pdf"'}})}catch(e){return console.error("Error in invoice endpoint:",e),new Response(JSON.stringify({message:"Error generating invoice",error:e.message}),{status:500})}}},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},59145:(e,t,r)=>{"use strict";r.r(t),r.d(t,{POST:()=>i,validatePaymentDetails:()=>o});var n=r(32190);function o(e,t){if(!/^\d{16}$/.test(e))return{isValid:!1,error:"Invalid card number format"};let[r,n]=t.split("/");if(!r||!n)return{isValid:!1,error:"Invalid expiry date format"};let o=parseInt(r,10),i=parseInt(n,10)+2e3;if(o<1||o>12)return{isValid:!1,error:"Invalid month in expiry date"};let s=new Date;return new Date(i,o-1,1)<s?{isValid:!1,error:"Card has expired"}:{isValid:!0}}async function i(e){try{let{cardNumber:t,expiryDate:r}=await e.json();if(console.log(t,r),!t||!r)return n.NextResponse.json({message:"Missing required fields: cardNumber and expiryDate"},{status:400});let i=o(t,r);return n.NextResponse.json(i,{status:200})}catch(e){return n.NextResponse.json({message:"Invalid JSON data"},{status:400})}}},62802:(e,t,r)=>{"use strict";r.d(t,{Er:()=>d,HU:()=>p,HY:()=>f,b9:()=>g,nr:()=>h});var n=r(43205),o=r.n(n),i=r(85663);let s=process.env.ACCESS_SECRET,a=process.env.REFRESH_SECRET,l=process.env.ACCESS_TOKEN_EXPIRY,u=process.env.REFRESH_TOKEN_EXPIRY,c=parseInt(process.env.SALT_ROUNDS,10);function d(e){return i.Ay.hashSync(e,c)}function g(e,t){return i.Ay.compareSync(e,t)}function p(e,t){return t?o().sign(e,s,{expiresIn:l}):o().sign(e,a,{expiresIn:u})}function f(e){return e?m(l):m(u)}function h(e,t){let r;if("object"==typeof e){let t=e.headers.get("Authorization");if(!t)return null;r=t.replace("Bearer ","")}else r=e;try{let e;if((e=t?o().verify(r,s):o().verify(r,a)).exp&&e.exp<Math.floor(Date.now()/1e3))return null;return e}catch{return null}}function m(e){let t;let r=e.slice(-1),n=parseInt(e.slice(0,-1),10);if("s"===r)t=n;else if("m"===r)t=60*n;else if("h"===r)t=3600*n;else if("d"===r)t=86400*n;else throw Error("Unsupported time unit");return t}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{},97474:(e,t,r)=>{"use strict";r.d(t,{z:()=>n});let n=new(r(96330)).PrismaClient}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[7719,580,5315],()=>r(6269));module.exports=n})();