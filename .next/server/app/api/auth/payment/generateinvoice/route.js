(()=>{var e={};e.id=2060,e.ids=[2060],e.modules={8826:(e,t,n)=>{"use strict";n.r(t),n.d(t,{patchFetch:()=>g,routeModule:()=>s,serverHooks:()=>c,workAsyncStorage:()=>l,workUnitAsyncStorage:()=>u});var r=n(96559),o=n(48088),i=n(37719),a=n(15821);let s=new r.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/auth/payment/generateinvoice/route",pathname:"/api/auth/payment/generateinvoice",filename:"route",bundlePath:"app/api/auth/payment/generateinvoice/route"},resolvedPagePath:"/app/app/api/auth/payment/generateinvoice/route.js",nextConfigOutput:"",userland:a}),{workAsyncStorage:l,workUnitAsyncStorage:u,serverHooks:c}=s;function g(){return(0,i.patchFetch)({workAsyncStorage:l,workUnitAsyncStorage:u})}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},15821:(e,t,n)=>{"use strict";n.r(t),n.d(t,{POST:()=>u,generateInvoice:()=>l,runtime:()=>s});let r=require("pdfkit");var o=n.n(r),i=n(27910),a=n(97474);let s="nodejs";async function l(e,t,n){console.log("generateInvoice: started"),console.log("Booking:",e),console.log("Payment:",t),console.log("User:",n);let r=await a.z.user.findUnique({where:{id:n.id}}),s=null,l="";if(e.flightBookingInfo){try{s=JSON.parse(e.flightBookingInfo)}catch(e){console.error("Error parsing flightBookingInfo:",e)}s&&(Array.isArray(s.flights)?(l+="Flight Information (Round/Multiple Segments):\n",s.flights.forEach((e,t)=>{l+=`  Flight ${t+1}:
    Flight Number: ${e.flightNumber}
    Origin: ${e.origin}
    Destination: ${e.destination}
    Airline: ${e.airline}
    Departure: ${new Date(e.departureTime).toLocaleString()}
    Arrival: ${new Date(e.arrivalTime).toLocaleString()}
    Status: ${e.status}
    Price: $${e.price}

`})):l+=`Flight Information:
  Flight Number: ${s.flightNumber}
  Origin: ${s.origin}
  Destination: ${s.destination}
  Airline: ${s.airline}
  Departure: ${new Date(s.departureTime).toLocaleString()}
  Arrival: ${new Date(s.arrivalTime).toLocaleString()}
  Status: ${s.status}
  Price: $${s.price}
`)}let u=null,c=null,g=null,p=null,m=null;if(e.roomBookingInfo){try{u=JSON.parse(e.roomBookingInfo)}catch(e){console.error("Error parsing roomBookingInfo:",e)}u&&(p=u.hotelId||null,m=u.roomId||null,c=u.checkIn?new Date(u.checkIn):null,g=u.checkOut?new Date(u.checkOut):null)}c=c||(e.checkIn?new Date(e.checkIn):null),g=g||(e.checkOut?new Date(e.checkOut):null),p=p||e.hotelId||null,m=m||e.roomId||null;let d=new(o())({autoFirstPage:!1}),h=new i.PassThrough,f=[];return d.pipe(h),h.on("data",e=>f.push(e)),d.addPage(),d.font("Times-Roman"),d.fontSize(18).text("FlyNext Booking Invoice",{align:"center"}),d.moveDown(),d.fontSize(12).text(`Name: ${r.firstName} ${r.lastName}`),d.text(`Email: ${r.email}`),d.moveDown(),d.text(`Booking ID: ${e.id}`),d.moveDown(),e.flightBookingInfo&&(d.text("Flight Details:"),l?d.text(l):d.text(e.flightBookingInfo),d.moveDown()),p&&m&&(d.text(`Hotel Booking: Hotel ID ${p}, Room ID ${m}`),c&&g&&(d.text(`Check-In: ${c.toLocaleDateString()}`),d.text(`Check-Out: ${g.toLocaleDateString()}`)),d.moveDown()),d.text(`Total Amount: $${t.amount}`),d.text(`Payment Status: ${t.status}`),d.end(),new Promise((e,t)=>{h.on("end",()=>{console.log("generateInvoice: Invoice generated successfully"),e(Buffer.concat(f))}),h.on("error",e=>{console.error("generateInvoice: Error generating invoice:",e),t(Error("Failed to generate PDF invoice."))})})}async function u(e){try{let{booking:t,payment:n,user:r}=await e.json();if(!t||!n||!r)return new Response(JSON.stringify({message:"Missing required fields: booking, payment, and user"}),{status:400});let o=await l(t,n,r);return new Response(o,{status:200,headers:{"Content-Type":"application/pdf","Content-Disposition":'attachment; filename="invoice.pdf"'}})}catch(e){return console.error("Error in invoice endpoint:",e),new Response(JSON.stringify({message:"Error generating invoice",error:e.message}),{status:500})}}},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{},96559:(e,t,n)=>{"use strict";e.exports=n(44870)},97474:(e,t,n)=>{"use strict";n.d(t,{z:()=>r});let r=new(n(96330)).PrismaClient}};var t=require("../../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[7719],()=>n(8826));module.exports=r})();